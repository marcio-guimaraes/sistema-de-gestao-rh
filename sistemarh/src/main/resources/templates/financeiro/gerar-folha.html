<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gerar Folha de Pagamento - MeuRH</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/financeiro.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header th:replace="~{layout :: header}"></header>
<main class="container py-5">

    <div class="card mx-auto mb-5" style="max-width: 600px;">
        <div class="card-body text-center">
            <h4 class="card-title">Gerar Folha de Pagamento</h4>
            <p>Selecione o mês e o ano para gerar e salvar a folha de pagamento.</p>
            <p class="text-muted small">A folha gerada será exibida abaixo para conferência.</p>

            <form th:action="@{/financeiro/gerar-folha/processar}" method="post">
                <div class="row">
                    <div class="col mb-3">
                        <label for="mes" class="form-label">Mês</label>
                        <select class="form-select" id="mes" name="mes" th:value="${mesSelecionado}">
                            <option th:each="m : ${#numbers.sequence(1, 12)}"
                                    th:value="${m}"
                                    th:text="${T(java.time.Month).of(m).getDisplayName(T(java.time.format.TextStyle).FULL, new java.util.Locale('pt', 'BR'))}"
                                    th:selected="${m == mesSelecionado}">
                            </option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <label for="ano" class="form-label">Ano</label>
                        <input type="number" class="form-control" id="ano" name="ano" th:value="${anoSelecionado}" required>
                    </div>
                </div>
                <button type.="submit" class="btn btn-info btn-lg text-white">
                    Gerar e Salvar Folha
                </button>
            </form>
        </div>
    </div>

    <div th:if="${folha != null}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 th:text="${'Folha de Pagamento - ' + folha.mesPorExtenso + '/' + folha.anoReferencia}"></h3>
            <a th:href="@{/financeiro/gerar-folha/txt(mes=${folha.mesReferencia}, ano=${folha.anoReferencia})}"
               class="btn btn-info text-white"
               target="_blank">
                Exportar TXT Formatado
            </a>
        </div>

        <div class="card">
            <div class="card-header">Detalhamento por Funcionário</div>
            <div class="card-body table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>Funcionário</th>
                        <th>Cargo</th>
                        <th>Salário Base</th>
                        <th>Benefícios (VA+VT)</th>
                        <th>Descontos</th>
                        <th>Salário Líquido</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(folha.funcionarios)}">
                        <td colspan="6" class="text-center">Nenhum funcionário ativo encontrado.</td>
                    </tr>
                    <tr th:each="f : ${folha.funcionarios}" th:with="
                            bruto=${f.baseSalario + f.regraSalario.valorValeAlimentacao + f.regraSalario.valorValeTransporte},
                            liquido=${f.calcularSalario()},
                            beneficios=${f.regraSalario.valorValeAlimentacao + f.regraSalario.valorValeTransporte},
                            descontos=${bruto - liquido}">

                        <td th:text="${f.nome}"></td>
                        <td th:text="${f.cargo}"></td>
                        <td th:text="${'R$ ' + #numbers.formatDecimal(f.baseSalario, 1, 'POINT', 2, 'COMMA')}"></td>
                        <td th:text="${'R$ ' + #numbers.formatDecimal(beneficios, 1, 'POINT', 2, 'COMMA')}"></td>
                        <td class="text-danger" th:text="${'(R$ ' + #numbers.formatDecimal(descontos, 1, 'POINT', 2, 'COMMA') + ')'}"></td>
                        <td class="fw-bold" th:text="${'R$ ' + #numbers.formatDecimal(liquido, 1, 'POINT', 2, 'COMMA')}"></td>
                    </tr>
                    </tbody>
                    <tfoot class="table-group-divider fw-bold fs-5">
                    <tr>
                        <td colspan="2">TOTAIS DA FOLHA</td>
                        <td></td>
                        <td th:text="${'Bruto: R$ ' + #numbers.formatDecimal(folha.valorTotalBruto, 1, 'POINT', 2, 'COMMA')}"></td>
                        <td class="text-danger" th:text="${'Descontos: (R$ ' + #numbers.formatDecimal(folha.valorTotalDescontos, 1, 'POINT', 2, 'COMMA') + ')'}"></td>
                        <td th:text="${'Líquido: R$ ' + #numbers.formatDecimal(folha.valorTotalLiquido, 1, 'POINT', 2, 'COMMA')}"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div th:if="${folha == null}" class="text-center text-muted">
        <p>Selecione o mês e o ano e clique em "Gerar e Salvar Folha" para ver os resultados.</p>
    </div>

</main>
<footer th:replace="~{layout :: footer}"></footer>
</body>
</html>