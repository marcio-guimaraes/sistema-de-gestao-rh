<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Relatório Financeiro</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/financeiro.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header th:replace="~{layout :: header}"></header>
<main class="container py-5">

    <h3>Relatório Financeiro</h3>

    <div class="card mb-4">
        <div class="card-body">
            <form th:action="@{/financeiro/relatorio}" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="departamento" class="form-label">Departamento</label>
                    <select id="departamento" name="departamento" class="form-select">
                        <option value="">Todos</option>
                        <option th:each="depto : ${departamentos}"
                                th:value="${depto}"
                                th:text="${depto}"
                                th:selected="${depto == deptoFiltro}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="cargo" class="form-label">Cargo</label>
                    <select id="cargo" name="cargo" class="form-select">
                        <option value="">Todos</option>
                        <option th:each="c : ${cargos}"
                                th:value="${c}"
                                th:text="${c}"
                                th:selected="${c == cargoFiltro}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="regraSalarialId" class="form-label">Regra Salarial</label>
                    <select id="regraSalarialId" name="regraSalarialId" class="form-select">
                        <option value="">Todas</option>
                        <option th:each="r : ${regrasSalariais}"
                                th:value="${r.id}"
                                th:text="${r.nomeRegra}"
                                th:selected="${r.id == regraFiltro}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="Ativo" th:selected="${'Ativo' == statusFiltro}">Ativo</option>
                        <option value="Inativo" th:selected="${'Inativo' == statusFiltro}">Inativo</option>
                    </select>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a th:href="@{/financeiro/relatorio}" class="btn btn-secondary">Limpar Filtros</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            Resultado
            <div>
                <a th:href="@{/financeiro/relatorio/txt(departamento=${deptoFiltro}, cargo=${cargoFiltro}, regraSalarialId=${regraFiltro}, status=${statusFiltro})}"
                   class="btn btn-info btn-sm text-white"
                   target="_blank">
                    Exportar TXT Formatado
                </a>
            </div>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Funcionário</th>
                    <th>Status</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Salário Base</th>
                    <th>Benefícios</th>
                    <th>Descontos</th>
                    <th>Salário Líquido</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${#lists.isEmpty(funcionarios)}">
                    <td colspan="8" class="text-center">Nenhum funcionário encontrado com os filtros aplicados.</td>
                </tr>
                <tr th:each="f : ${funcionarios}">
                    <td th:text="${f.nome}"></td>
                    <td>
                        <span class="badge"
                              th:classappend="${f.status == 'Ativo' ? 'bg-success' : 'bg-secondary'}"
                              th:text="${f.status}"></span>
                    </td>
                    <td th:text="${f.cargo}"></td>
                    <td th:text="${f.departamento}"></td>
                    <td th:text="${'R$ ' + #numbers.formatDecimal(f.baseSalario, 1, 'POINT', 2, 'COMMA')}"></td>

                    <th:block th:if="${f.regraSalario != null}" th:with="bruto=${f.baseSalario + f.regraSalario.valorValeAlimentacao + f.regraSalario.valorValeTransporte},
                                               liquido=${f.calcularSalario()}">
                        <td th:text="${'R$ ' + #numbers.formatDecimal(bruto - f.baseSalario, 1, 'POINT', 2, 'COMMA')}"></td>
                        <td th:text="${'R$ ' + #numbers.formatDecimal(bruto - liquido, 1, 'POINT', 2, 'COMMA')}"></td>
                        <td class="fw-bold" th:text="${'R$ ' + #numbers.formatDecimal(liquido, 1, 'POINT', 2, 'COMMA')}"></td>
                    </th:block>
                    <th:block th:if="${f.regraSalario == null}">
                        <td colspan="3" class="text-danger text-center">Regra salarial não definida</td>
                    </th:block>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
<footer th:replace="~{layout :: footer}"></footer>
</body>
</html>